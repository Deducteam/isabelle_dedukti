.SUFFIXES:

.PHONY: default help
default help:
	@echo usage: make [-j...] [target] SESSION=... [VAR=...] ...
	@echo
	@echo possible targets:
	@echo - build: for Isabelle to generate the proofs of the given session
	@echo - dk: to translate the Isabelle proofs to Dedukti
	@echo - dko: to check the generated Dedukti files
	@echo - lp: to translate the Isabelle proofs to Lambdapi
	@echo - lpo: to check the generated Lambdapi files
	@echo - v: to translate the Dedukti files to Rocq
	@echo - vo: to check the generated Rocq files
	@echo
	@echo user-definable variables:
	@echo - ISADK_DIR: source directory of isabelle_dedukti
	@echo - OUT_DIR: directory where to put generated files
	@echo - ROCQ_OPTIONS: rocq options
	@echo - ROOT_DIR: ROOT file directory

ISADK_DIR = ..
ROCQ_OPTIONS = -q -no-glob
ROOT_DIR = .
OUT_DIR = .

TIME := /usr/bin/time -f %e
SESSION_DIR := $(ROOT_DIR)/$(SESSION)
# dk does not allow . and - in module names, they are replaced by _
SESSION_MODNAME := session_$(subst .,_,$(subst -,_,$(SESSION)))

############# generation of Isabelle proofs ##############

include isadb_dir.mk

isadb_dir.mk:
	@echo ISADB_DIR = `isabelle getenv -b ISABELLE_HOME_USER`/heaps/`isabelle getenv -b ML_SYSTEM`_`isabelle getenv -b ML_PLATFORM`/log > $@

.PHONY: clean-isadb-dir.mk
clean-isadb_dir.mk:
	rm -f isadb_dir.mk

ifneq ($(SESSION),"Pure")
.PHONY: build
build: $(ISADB_DIR)/$(SESSION).db

$(ISADB_DIR)/%.db: $(ROOT_DIR)/ROOT $(SESSION_DIR)
	@if test -f $@; then touch $@; else isabelle build -b -d$(ROOT_DIR) $*; fi

$(SESSION_DIR): $(ROOT_DIR)/ROOT
	@if grep -q "session $(SESSION) " $<; then echo mkdir $@; mkdir -p $@; touch $@; else echo "there is no session $(SESSION) in $<"; exit 1; fi

.PHONY: clean-build
clean-build:
	rm -f $(ISADB_DIR)/$(SESSION).db
endif

############# generation of Dedukti files ##############

.PHONY: dk
dk: $(OUT_DIR)/$(SESSION_MODNAME).dk

ifeq ($(SESSION),Pure)
$(OUT_DIR)/$(SESSION_MODNAME).dk: $(OUT_DIR)/STTfa.dk
	isabelle dedukti_generate -k -d$(ROOT_DIR) -D$(OUT_DIR) $(ISADK_OPT) $(SESSION)
	@touch $@
else
$(OUT_DIR)/$(SESSION_MODNAME).dk: $(ISADB_DIR)/$(SESSION).db $(OUT_DIR)/STTfa.dk
	isabelle dedukti_generate -k -d$(ROOT_DIR) -D$(OUT_DIR) $(ISADK_OPT) $(SESSION)
	@touch $@
endif

$(OUT_DIR)/STTfa.dk: $(ISADK_DIR)/STTfa.dk
	cp -f $< $@

.PHONY: clean-dk
clean-dk: rm-dk rm-dko clean-v rm-dko-mk

.PHONY: rm-dk
rm-dk:
	find $(OUT_DIR) -maxdepth 1 -name '*.dk' -delete

.PHONY: rm-dko-mk
rm-dko-mk:
	find $(OUT_DIR) -maxdepth 1 -name 'dkcheck_*.mk' -delete

############# verification of Dedukti files ##############

# makefiles generated by isabelle dedukti_generate -k
include $(wildcard $(OUT_DIR)/dkcheck_*.mk)

.PHONY: dko
dko: $(OUT_DIR)/$(SESSION_MODNAME).dko

%.dko: %.dk
	dk check -I $(OUT_DIR) -e --eta $<

.PHONY: clean-dko
clean-dko: rm-dko

.PHONY: rm-dko
rm-dko:
	find $(OUT_DIR) -maxdepth 1 -name '*.dko' -delete

############# generation of Lambdapi files ##############

.PHONY: lp
lp: $(OUT_DIR)/lambdapi.pkg $(OUT_DIR)/STTfa.lp $(OUT_DIR)/$(SESSION_MODNAME).lp

$(OUT_DIR)/lambdapi.pkg: $(ISADK_DIR)/lambdapi.pkg
	cp -f $< $@

$(OUT_DIR)/STTfa.lp: $(ISADK_DIR)/STTfa.lp
	cp -f $< $@

ifeq ($(SESSION),Pure)
$(OUT_DIR)/$(SESSION_MODNAME).lp: $(OUT_DIR)/STTfa.lp
	isabelle dedukti_generate -d$(ROOT_DIR) -D$(OUT_DIR) $(ISADK_OPT) $(SESSION)
else
$(OUT_DIR)/$(SESSION_MODNAME).lp: $(ISADB_DIR)/$(SESSION).db $(OUT_DIR)/STTfa.lp
	isabelle dedukti_generate -d$(ROOT_DIR) -D$(OUT_DIR) $(ISADK_OPT) $(SESSION)
endif

.PHONY: clean-lp
clean-lp: rm-lp rm-lpo-mk rm-pkg clean-lpo clean-v

.PHONY: rm-pkg
rm-pkg:
	rm -f $(OUT_DIR)/lambdapi.pkg

.PHONY: rm-lp
rm-lp:
	find $(OUT_DIR) -maxdepth 1 -name '*.lp' -delete

.PHONY: rm-lpo-mk
rm-lpo-mk:
	find $(OUT_DIR) -maxdepth 1 -name 'lpcheck_*.mk' -delete

############# verification of Lambdapi files ##############

# makefiles generated by isabelle dedukti_generate
include $(wildcard $(OUT_DIR)/lpcheck_*.mk)

.PHONY:lpo
lpo: $(OUT_DIR)/$(SESSION_MODNAME).lpo

%.lpo: %.lp
	lambdapi check -c -w -v0 $<

.PHONY: clean-lpo
clean-lpo: rm-lpo

.PHONY: rm-lpo
rm-lpo:
	find $(OUT_DIR) -maxdepth 1 -name '*.lpo' -delete

############# generation of Rocq files ##############

DK_FILES := $(wildcard $(OUT_DIR)/*.dk)
#LP_FILES := $(wildcard $(OUT_DIR)/*.lp)

.PHONY: v
v: $(OUT_DIR)/mappings.v $(DK_FILES:%.dk=%.v)

LAMBDAPI = lambdapi

$(OUT_DIR)/mappings.v: $(ISADK_DIR)/mappings.v
	cp -f $< $@

%.v: %.dk
	@echo lambdapi export -o stt_coq $<
	@$(LAMBDAPI) export -o stt_coq --encoding $(ISADK_DIR)/encoding.lp --mapping $(ISADK_DIR)/mappings.lp --renaming $(ISADK_DIR)/renaming.lp --requiring mappings $< | sed -e '/^Require STTfa\./d' > $@

#%.v: %.lp
#	@echo lambdapi export -o stt_coq $<
#	@$(LAMBDAPI) export -o stt_coq --encoding $(ISADK_DIR)/encoding.lp --mapping $(ISADK_DIR)/mappings.lp --renaming $(ISADK_DIR)/renaming.lp --requiring mappings $< | sed -e '/^Require Isabelle\.STTfa\./d' > $@

.PHONY: clean-v
clean-v: rm-v rm-vo-mk clean-vo

.PHONY: rm-v
rm-v:
	find $(OUT_DIR) -maxdepth 1 -name '*.v' -delete

.PHONY: rm-vo-mk
rm-vo-mk:
	find $(OUT_DIR) -maxdepth 1 -name 'rocqcheck_*.mk' -delete

############# verification of Rocq files ##############

include $(subst dkcheck,rocqcheck,$(wildcard $(OUT_DIR)/dkcheck_*.mk))

$(OUT_DIR)/rocqcheck_%.mk : $(OUT_DIR)/dkcheck_%.mk
	@echo generate $@
	@sed -e 's/\.dk/\.v/g' $< > $@
	@echo >> $@
	@echo '$$(OUT_DIR)/STTfa.vo: $$(OUT_DIR)/mappings.vo' >> $@

.PHONY: vo
vo: $(OUT_DIR)/$(SESSION_MODNAME).vo

%.vo: %.v
	@echo rocq compile $<
	@rocq compile $(ROCQ_OPTIONS) $<

.PHONY: clean-vo
clean-vo: rm-vo rm-aux rm-caches

.PHONY: rm-vo
rm-vo:
	find $(OUT_DIR) -maxdepth 1 -name '*.vo*' -delete

.PHONY: rm-aux
rm-aux:
	find $(OUT_DIR) -maxdepth 1 -name '.*.aux' -delete

.PHONY: rm-caches
rm-caches:
	rm -f $(OUT_DIR)/.lia.cache $(OUT_DIR)/.nia.cache
