on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    paths:
      - '.github/workflows/main.yml'
      - 'src/*.scala'
      - 'HOL.patch'
  workflow_dispatch:
jobs:
  isabelle_dedukti:
    strategy:
      fail-fast: false
      matrix:
        ocaml-version: [5.4.0]
        dedukti-version: [2.7]
        lambdapi-version: [3.0.0]
        isabelle-version: [2025]
    runs-on: ubuntu-latest
    steps:
      # actions/checkout must be done BEFORE avsm/setup-ocaml
      - name: Checkout isabelle_dedukti
        uses: actions/checkout@v6
#      - name: Set up cache
#        id: cache
#        uses: actions/cache@v3
#        with:
#          path: |
#            ~/.isabelle
#            ~/kontroli-rs
#            ~/Isabelle${{ matrix.isabelle-version }}
#            ~/.opam
#          key: cache-${{ runner.os }}
      - name: Download Isabelle
#        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          # because github fails if downloading a file takes too much time and Isabelle2025 is big (1.1G instead of 0.66G for Isabelle2024)
          until wget -c https://isabelle.in.tum.de/website-Isabelle${{ matrix.isabelle-version }}/dist/Isabelle${{ matrix.isabelle-version }}_linux.tar.gz; do :; done
          tar -xzf Isabelle${{ matrix.isabelle-version }}_linux.tar.gz -C ~
      - name: Create ~/.isabelle directory
        run: |
          export PATH=$PATH:~/Isabelle${{ matrix.isabelle-version }}/bin
          isabelle build
      - name: Build isabelle_dedukti
        run: |
          ~/Isabelle${{ matrix.isabelle-version }}/bin/isabelle components -u .
          ~/Isabelle${{ matrix.isabelle-version }}/bin/isabelle scala_build
      - name: Patch Isabelle/HOL library
        run: |
          chmod -R +w ~/Isabelle${{ matrix.isabelle-version }}/src/HOL/
          patch -up0 -d ~/Isabelle${{ matrix.isabelle-version }}/src/HOL/ < HOL.patch
      - name: Install opam
#        if: steps.cache.outputs.cache-hit != 'true'
        uses: avsm/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ matrix.ocaml-version }}
      - name: Install dkcheck
        run: opam install dedukti.${{ matrix.dedukti-version }}
      - name: Check dk output for HOL_Groups
        run: |
          eval $(opam env)
          export PATH=$PATH:~/Isabelle${{ matrix.isabelle-version }}/bin
          cd examples
          make SESSION=Pure dk
          make SESSION=Pure dko
          make SESSION=HOL_Groups_wp dk
          make SESSION=HOL_Groups_wp dko
#          mkdir -p kocheck
#          ../../remove-requires.sh *.dk
#          cd kocheck
#          bash ../kocheck.sh
#          dk dep *.dk > deps.mk
#          make -f dedukti.mk
      - name: Install lambdapi
        run: opam install lambdapi.${{ matrix.lambdapi-version }}
#      - name: Install kocheck
#        run: |
#          cd ~
#          git clone https://github.com/01mf02/kontroli-rs.git
#          cd ~/kontroli-rs
#          cargo install --path kocheck
      - name: Generate and check lp output for HOL_Groups
        run: |
          eval $(opam env)
          export PATH=$PATH:~/Isabelle${{ matrix.isabelle-version }}/bin
          cd examples
          make SESSION=Pure lp
          make SESSION=Pure lpo
          make SESSION=HOL_Groups_wp lp
          make SESSION=HOL_Groups_wp lpo
